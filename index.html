!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Localizações</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh; /* Ocupar 100% da altura da viewport */
        }
        #map {
            height: 100%; /* O mapa vai preencher o espaço disponível */
            width: 100%;
            background-color: #f0f0f0; /* Fundo enquanto o mapa carrega */
        }
        #loading-message {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 1.2em;
        }
        .info-window-content {
            font-family: Arial, sans-serif;
            line-height: 1.5;
        }
        .info-window-content h3 {
            margin: 0 0 5px 0;
            color: #0056b3;
            font-size: 1.1em;
        }
        .info-window-content p {
            margin: 0;
            font-size: 0.9em;
            color: #555;
        }
        .info-window-content img {
            max-width: 80px;
            max-height: 80px;
            margin-bottom: 5px;
            border-radius: 4px;
            object-fit: contain;
        }
    </style>
    <script async defer src="https://maps.googleapis.com/maps/api/js?AIzaSyBv_ovaiZt-epwBcHfGn8cnxmdrChEn6Yw&callback=initMap&libraries=places"></script>
</head>
<body>
    <div id="map"></div>
    <div id="loading-message">Waiting for data from Wix to load map...</div>

    <script>
        let map;
        let geocoder;
        let markers = []; // Para armazenar os marcadores e gerenciá-los
        let infoWindow; // Para exibir informações quando um marcador é clicado

        // Esta função é chamada pela Google Maps API quando ela está pronta
        function initMap() {
            // Define o centro inicial do mapa (Alvor, Portugal)
            const alvor = { lat: 37.135, lng: -8.586 }; // Aproximado para Alvor

            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 10, // Zoom inicial
                center: alvor,
                mapTypeControl: false, // Opcional: remover o controle de tipo de mapa
                streetViewControl: false // Opcional: remover o Street View
            });

            geocoder = new google.maps.Geocoder();
            infoWindow = new google.maps.InfoWindow(); // Cria uma instância da InfoWindow

            // Ocultar mensagem de carregamento se o mapa já carregou antes dos dados
            document.getElementById('loading-message').style.display = 'none';
        }

        // Função para adicionar marcadores no mapa
        async function addMarkersToMap(locations) {
            // Limpa marcadores anteriores (se houver)
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            // Se a mensagem de carregamento ainda estiver visível, esconda-a
            document.getElementById('loading-message').style.display = 'none';

            if (!map || !geocoder) {
                console.error("Mapa ou Geocoder não inicializado. Verifique sua chave de API e callback.");
                document.getElementById('loading-message').textContent = "Erro: O mapa não carregou. Verifique a chave da API.";
                document.getElementById('loading-message').style.display = 'block';
                return;
            }

            if (!locations || locations.length === 0) {
                document.getElementById('loading-message').textContent = "Nenhum dado de localização recebido.";
                document.getElementById('loading-message').style.display = 'block';
                return;
            }

            const bounds = new google.maps.LatLngBounds(); // Para ajustar o zoom do mapa

            for (const item of locations) {
                const fullAddress = `${item.moradaCompleta || ''}, ${item.cp || ''}, Portugal`.trim();

                if (!fullAddress || fullAddress.length < 5) {
                    console.warn(`Endereço inválido para geocodificação: ${item.title || 'Título Desconhecido'}`);
                    continue;
                }

                try {
                    const geocodeResult = await geocoder.geocode({ 'address': fullAddress });

                    if (geocodeResult.results[0]) {
                        const location = geocodeResult.results[0].geometry.location;

                        const marker = new google.maps.Marker({
                            map: map,
                            position: location,
                            title: item.title || 'Local Desconhecido'
                        });

                        // Conteúdo da InfoWindow
                        const contentString = `
                            <div class="info-window-content">
                                ${item.logotipo ? `<img src="${item.logotipo}" alt="Logo">` : ''}
                                <h3>${item.title || 'Título Desconhecido'}</h3>
                                <p>${fullAddress}</p>
                            </div>
                        `;

                        // Adiciona um listener de clique ao marcador
                        marker.addListener("click", () => {
                            infoWindow.setContent(contentString);
                            infoWindow.open(map, marker);
                        });

                        markers.push(marker); // Adiciona o marcador ao array
                        bounds.extend(location); // Estende os limites para incluir este marcador

                    } else {
                        console.warn(`Não foi possível geocodificar o endereço para: ${item.title} (${fullAddress})`);
                    }
                } catch (e) {
                    console.error(`Erro na geocodificação para ${fullAddress}:`, e);
                }
            }

            // Ajusta o mapa para mostrar todos os marcadores
            if (markers.length > 0) {
                map.fitBounds(bounds);
            } else {
                document.getElementById('loading-message').textContent = "Nenhum local válido encontrado para exibir no mapa.";
                document.getElementById('loading-message').style.display = 'block';
            }
        }

        // Listener para mensagens do Wix (igual ao seu anterior, mas chama a função do mapa)
        window.onmessage = (event) => {
            // AVISO DE SEGURANÇA: Esta condição de origem foi removida para depuração.
            // Para produção, é ALTAMENTE RECOMENDADO reativar esta verificação
            // e garantir que event.origin corresponda ao seu domínio Wix publicado.
            // if (event.origin === "https://rutilportimao.wixsite.com") { // Exemplo
            try {
                const data = JSON.parse(event.data);
                console.log("Dados recebidos no iframe:", data); // Para depuração

                // Chama a função para adicionar marcadores ao mapa
                addMarkersToMap(data);

            } catch (error) {
                console.error("Error parsing message from Wix:", error);
                document.getElementById('loading-message').textContent = "Erro ao processar dados.";
                document.getElementById('loading-message').style.display = 'block';
            }
            // } else {
            //     console.warn("Message received from unexpected origin (blocked):", event.origin);
            //     // Opcional: mostrar mensagem de erro ou aviso ao usuário
            //     document.getElementById('loading-message').textContent = "Erro de segurança: origem de dados inesperada.";
            //     document.getElementById('loading-message').style.display = 'block';
            // }
        };
    </script>
</body>
</html>
