<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa com Dados Recebidos</title>
    <!-- Leaflet CSS para estilização do mapa -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
    <style>
        /* Garante que o mapa ocupe toda a altura e largura da viewport */
        #map {
            height: 100vh;
            width: 100%;
        }
        /* Reinicia as margens e preenchimentos padrão do navegador */
        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif; /* Usando a fonte Inter para consistência */
        }
        /* Estilos para o conteúdo dentro do popup */
        .popup-content-wrapper {
            display: flex; /* Habilita o Flexbox para alinhamento horizontal */
            align-items: center; /* Alinha verticalmente os itens ao centro */
            gap: 10px; /* Espaço entre a imagem e o texto */
            border-radius: 8px; /* Cantos arredondados para o wrapper */
            padding: 5px; /* Preenchimento em torno do conteúdo */
        }
        .popup-logo {
            width: 50px; /* Largura fixa para a imagem do logotipo */
            height: auto; /* Mantém a proporção */
            flex-shrink: 0; /* Impede que a imagem encolha */
            border-radius: 4px; /* Cantos ligeiramente arredondados para o logotipo */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* Sombra sutil para o logotipo */
        }
        .popup-details {
            display: flex;
            flex-direction: column; /* Empilha o título e o endereço verticalmente */
        }
        .popup-title {
            font-weight: bold;
            margin-bottom: 3px; /* Espaço menor abaixo do título */
            color: #333; /* Cor mais escura para o título */
        }
        .popup-details span {
            font-size: 0.9em; /* Fonte ligeiramente menor para os detalhes */
            color: #555; /* Cinza médio para os detalhes */
        }
        /* Estilos personalizados para os popups do Leaflet */
        .leaflet-popup-content-wrapper {
            border-radius: 8px; /* Cantos arredondados para todo o popup */
            box-shadow: 0 4px 8px rgba(0,0,0,0.15); /* Sombra mais proeminente para o popup */
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Biblioteca JavaScript do Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
    <script>
        // Inicializa o mapa, centrado em Portugal com um nível de zoom que mostra a maior parte do país.
        const map = L.map('map').setView([39.5, -8.0], 7);

        // Adiciona uma camada de mapa OpenStreetMap
        const layer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        });
        layer.addTo(map);

        /**
         * Adiciona um marcador ao mapa através da geocodificação de um endereço.
         * @param {Object} item - Um objeto contendo detalhes do endereço (address, postalCode, title, logotipo).
         * @returns {Array|null} - Um array [latitude, longitude] se a geocodificação for bem-sucedida, caso contrário, null.
         */
        async function addPinFromAddress(item) {
            console.log("Attempting to geocode with item data:", item); // DEBUG: Log the full item being processed

            // Construct the full address more robustly.
            // Ensure all relevant parts are included for better geocoding accuracy.
            // We explicitly add 'Portugal' to help Nominatim prioritize results within the country.
            const addressParts = [item.address, item.postalCode, 'Portugal'].filter(Boolean);
            const fullAddress = addressParts.join(', ');
            const encodedAddress = encodeURIComponent(fullAddress);

            let popupContent = '';
            // Constructs the popup content based on the availability of a logo
            if (item.logotipo) {
                popupContent += `<div class="popup-content-wrapper">`;
                // Uses a placeholder image if the logo URL fails to load
                popupContent += `<img src="${item.logotipo}" alt="Logotipo" class="popup-logo" onerror="this.onerror=null;this.src='https://placehold.co/50x50/cccccc/333333?text=Logo';">`;
                popupContent += `<div class="popup-details">`;
                popupContent += `<span class="popup-title">${item.title || 'Sem título'}</span>`;
                popupContent += `<span>${fullAddress}</span>`;
                popupContent += `</div>`;
                popupContent += `</div>`;
            } else {
                // Simpler popup content if no logo
                popupContent = `<b>${item.title || 'Sem título'}</b><br>${fullAddress}`;
            }

            try {
                // Geocoding request to the Nominatim OpenStreetMap API
                // 'countrycodes=pt' helps prioritize results within Portugal
                const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodedAddress}&format=json&limit=1&addressdetails=1&countrycodes=pt`, {
                    headers: {
                        // IMPORTANT: Replace 'YourAppName/1.0 (your-email@example.com)' with your actual application name and contact email.
                        // This is required by Nominatim's usage policy.
                        'User-Agent': 'MyWixMapApp/1.0 (your-email@example.com)'
                    }
                });
                const data = await response.json();
                console.log(`Nominatim API response for "${fullAddress}":`, data); // DEBUG: Log Nominatim response for inspection

                // Check if geocoding returned any results
                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);

                    // Create and add a marker to the map, binding the popup content
                    const marker = L.marker([lat, lon])
                        .addTo(map)
                        .bindPopup(popupContent);

                    console.log(`Successfully geocoded "${fullAddress}" to [${lat}, ${lon}]. Nominatim's interpretation: "${data[0].display_name}"`); // DEBUG: Log Nominatim's display name
                    return [lat, lon];
                } else {
                    console.warn(`Could not geocode address: "${fullAddress}". No results found. Nominatim response:`, data);
                    return null;
                }
            } catch (error) {
                console.error(`Error geocoding address "${fullAddress}":`, error);
                return null;
            }
        }

        /**
         * Iterates over a list of data items and adds markers to the map for each one.
         * After all markers are added, adjusts the map view to encompass all of them.
         * @param {Array<Object>} dados - An array of objects, each containing address information.
         */
        async function adicionarPins(dados) {
            console.log("Adding pins for data array:", dados); // DEBUG: Log incoming data array
            const allCoordinates = [];
            for (const item of dados) {
                const coords = await addPinFromAddress(item);
                if (coords) {
                    allCoordinates.push(coords);
                }
            }

            // Adjust map bounds to fit all successfully added markers
            if (allCoordinates.length > 0) {
                map.fitBounds(allCoordinates, { padding: [50, 50] }); // Add padding to keep markers away from the edge
                console.log("Map bounds adjusted to fit all pins."); // DEBUG: Confirm map adjustment
            } else {
                console.warn("No valid locations found to display on the map. Map view remains at initial setting.");
            }
        }

        // Event listener to receive messages (data) from the parent frame (e.g., Wix)
        window.addEventListener("message", function (event) {
            console.log("Message received from Wix:", event.data); // DEBUG: Log raw message received
            try {
                // Tries to parse the received data as JSON
                const data = JSON.parse(event.data);
                console.log("Parsed data from Wix:", data); // DEBUG: Log parsed data structure
                // Checks if the parsed data is an array
                if (Array.isArray(data)) {
                    adicionarPins(data); // Calls the function to add markers
                } else {
                    console.warn("Received data is not an array:", data);
                }
            } catch (e) {
                console.error("Error parsing message from sender:", e);
            }
        }, false); /* 'false' indicates the event propagation phase, 'true' is the capture phase */
    </script>
</body>
</html>
