<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Mapa com Dados Recebidos</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
        body, html {
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
    <script>
        // Initialize map
        // Set initial view directly to Portimão for a better starting point
        const map = L.map('map').setView([37.136569, -8.5376], 13); // Centered on Portimão with a good zoom
        const layer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        });
        layer.addTo(map);

        // Function to geocode an address and add a pin
        async function addPinFromAddress(item) {
            // Construct the full address string, using hardcoded city and country
            const fullAddress = `${item.address || ''}, Portimão, Portugal`;
            
            // Encode the address for the URL
            const encodedAddress = encodeURIComponent(fullAddress);

            try {
                // Nominatim API endpoint
                const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodedAddress}&format=json&limit=1&addressdetails=1`);
                const data = await response.json();

                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);

                    const marker = L.marker([lat, lon])
                        .addTo(map)
                        .bindPopup(`<b>${item.title || 'Sem título'}</b><br>${fullAddress}`);
                    
                    return [lat, lon];
                } else {
                    console.warn(`Could not geocode address: "${fullAddress}". No results found.`);
                    return null;
                }
            } catch (error) {
                console.error(`Error geocoding address "${fullAddress}":`, error);
                return null;
            }
        }

        // Function to add pins to the map from the received data
        async function adicionarPins(dados) {
            const allCoordinates = [];
            // Process each item sequentially to respect Nominatim rate limits
            for (const item of dados) {
                const coords = await addPinFromAddress(item);
                if (coords) {
                    allCoordinates.push(coords);
                }
            }
            
            // Adjust map view to show all successfully geocoded pins
            if (allCoordinates.length > 0) {
                map.fitBounds(allCoordinates, { padding: [50, 50] });
            } else {
                console.warn("No valid locations found to display on the map.");
            }
        }

        // Listen for messages from Wix
        window.addEventListener("message", function (event) {
            try {
                // For security, it's a good practice to check event.origin against your Wix site URL
                const data = JSON.parse(event.data);

                if (Array.isArray(data)) {
                    adicionarPins(data);
                } else {
                    console.warn("Received data is not an array:", data);
                }
            } catch (e) {
                console.error("Error parsing message from Wix:", e);
            }
        }, false);
    </script>
</body>
</html>
