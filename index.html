<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Localizações</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="  crossorigin=""/>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh; /* Ocupar 100% da altura da viewport */
        }
        #map {
            height: 100%; /* O mapa vai preencher o espaço disponível */
            width: 100%;
            background-color: #f0f0f0; /* Fundo enquanto o mapa carrega */
        }
        #loading-message {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 1.2em;
        }
        .info-window-content {
            font-family: Arial, sans-serif;
            line-height: 1.5;
        }
        .info-window-content h3 {
            margin: 0 0 5px 0;
            color: #0056b3;
            font-size: 1.1em;
        }
        .info-window-content p {
            margin: 0;
            font-size: 0.9em;
            color: #555;
        }
        .info-window-content img {
            max-width: 80px;
            max-height: 80px;
            margin-bottom: 5px;
            border-radius: 4px;
            object-fit: contain;
        }
    </style>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="  crossorigin=""></script>
</head>
<body>
    <div id="map"></div>
    <div id="loading-message">Waiting for data from Wix to load map...</div>

    <script>
        let map;
        let markers = L.featureGroup(); // To store markers and manage them

        // This function initializes the Leaflet map
        function initMap() {
            // Define o centro inicial do mapa (Alvor, Portugal)
            const alvor = { lat: 37.135, lng: -8.586 }; // Aproximado para Alvor

            map = L.map('map').setView([alvor.lat, alvor.lng], 10); // Initialize map with center and zoom

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Add the feature group to the map
            markers.addTo(map);

            // Ocultar mensagem de carregamento se o mapa já carregou antes dos dados
            document.getElementById('loading-message').style.display = 'none';
        }

        // Initialize the map when the script loads
        initMap();

        // Function to add markers to the map
        async function addMarkersToMap(locations) {
            // Clear previous markers (if any)
            markers.clearLayers();

            // If the loading message is still visible, hide it
            document.getElementById('loading-message').style.display = 'none';

            if (!map) {
                console.error("Mapa não inicializado.");
                document.getElementById('loading-message').textContent = "Erro: O mapa não carregou.";
                document.getElementById('loading-message').style.display = 'block';
                return;
            }

            if (!locations || locations.length === 0) {
                document.getElementById('loading-message').textContent = "Nenhum dado de localização recebido.";
                document.getElementById('loading-message').style.display = 'block';
                return;
            }

            const latLngs = []; // To store all marker coordinates for fitting bounds

            for (const item of locations) {
                const fullAddress = `${item.moradaCompleta || ''}, ${item.cp || ''}, Portugal`.trim();

                if (!fullAddress || fullAddress.length < 5) {
                    console.warn(`Endereço inválido para geocodificação: ${item.title || 'Título Desconhecido'}`);
                    continue;
                }

                try {
                    // Using OpenStreetMap's Nominatim for geocoding
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullAddress)}`);
                    const data = await response.json();

                    if (data && data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lng = parseFloat(data[0].lon);
                        const location = L.latLng(lat, lng);

                        // Content for the popup
                        const contentString = `
                            <div class="info-window-content">
                                ${item.logotipo ? `<img src="${item.logotipo}" alt="Logo">` : ''}
                                <h3>${item.title || 'Título Desconhecido'}</h3>
                                <p>${fullAddress}</p>
                            </div>
                        `;

                        const marker = L.marker(location).bindPopup(contentString);
                        markers.addLayer(marker); // Add marker to the feature group
                        latLngs.push(location); // Add coordinates for fitting bounds

                    } else {
                        console.warn(`Não foi possível geocodificar o endereço para: ${item.title} (${fullAddress})`);
                    }
                } catch (e) {
                    console.error(`Erro na geocodificação para ${fullAddress}:`, e);
                }
            }

            // Adjust the map to show all markers
            if (latLngs.length > 0) {
                map.fitBounds(L.latLngBounds(latLngs));
            } else {
                document.getElementById('loading-message').textContent = "Nenhum local válido encontrado para exibir no mapa.";
                document.getElementById('loading-message').style.display = 'block';
            }
        }

        // Listener for messages from Wix (same as your previous, but calls the map function)
        window.onmessage = (event) => {
            // SECURITY WARNING: The origin condition was removed for debugging.
            // For production, it is HIGHLY RECOMMENDED to re-enable this check
            // and ensure event.origin matches your published Wix domain.
            // if (event.origin === "https://rutilportimao.wixsite.com") { // Example
            try {
                const data = JSON.parse(event.data);
                console.log("Dados recebidos no iframe:", data); // For debugging

                // Call the function to add markers to the map
                addMarkersToMap(data);

            } catch (error) {
                console.error("Error parsing message from Wix:", error);
                document.getElementById('loading-message').textContent = "Erro ao processar dados.";
                document.getElementById('loading-message').style.display = 'block';
            }
            // } else {
            //      console.warn("Message received from unexpected origin (blocked):", event.origin);
            //      // Optional: show error or warning message to the user
            //      document.getElementById('loading-message').textContent = "Erro de segurança: origem de dados inesperada.";
            //      document.getElementById('loading-message').style.display = 'block';
            // }
        };
    </script>
</body>
</html>
