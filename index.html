<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Postal Code Geocoder - Portugal</title>
    <style>
        #map {
            height: 400px;
            width: 100%;
            margin-top: 20px;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
    <h1>Postal Code to Coordinates (Portugal)</h1>
    <input type="text" id="postalCodeInput" placeholder="Enter Postal Code (e.g., 8500-050 or 8500-710 PortimÃ£o)">
    <button id="geocodeButton">Geocode</button>
    <p>Latitude: <span id="latitude"></span></p>
    <p>Longitude: <span id="longitude"></span></p>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Replace with your actual Geoapify API Key
        const GEOAPIFY_API_KEY = 'e4c64a3a1721414ca9747bde14c59e2e';

        const postalCodeInput = document.getElementById('postalCodeInput');
        const geocodeButton = document.getElementById('geocodeButton');
        const latitudeSpan = document.getElementById('latitude');
        const longitudeSpan = document.getElementById('longitude');
        const mapContainer = document.getElementById('map');

        let map = null;
        let marker = null;

        function initMap(lat, lng) {
            if (map) {
                map.remove(); // Remove existing map if it exists
            }
            map = L.map('map').setView([lat, lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }

        geocodeButton.addEventListener('click', async () => {
            let postalCode = postalCodeInput.value.trim();
            // Hardcode country code to Portugal
            const countryCode = 'pt'; 

            // If the postal code contains a space, take only the part before the first space
            if (postalCode.includes(' ')) {
                postalCode = postalCode.split(' ')[0];
            }

            if (!postalCode) {
                alert('Please enter a postal code.');
                return;
            }

            try {
                const response = await fetch(`https://api.geoapify.com/v1/geocode/search?postcode=${postalCode}&countrycode=${countryCode}&apiKey=${GEOAPIFY_API_KEY}`);
                const data = await response.json();

                if (data.features && data.features.length > 0) {
                    const firstFeature = data.features[0];
                    const lat = firstFeature.properties.lat;
                    const lon = firstFeature.properties.lon;

                    latitudeSpan.textContent = lat;
                    longitudeSpan.textContent = lon;

                    initMap(lat, lon); // Initialize or update map
                    if (marker) {
                        marker.setLatLng([lat, lon]);
                    } else {
                        marker = L.marker([lat, lon]).addTo(map)
                            .bindPopup(`<b>${postalCode}</b><br>Lat: ${lat}<br>Lon: ${lon}`).openPopup();
                    }
                    map.setView([lat, lon], 13); // Center map on new location
                } else {
                    latitudeSpan.textContent = 'N/A';
                    longitudeSpan.textContent = 'N/A';
                    alert('Postal code not found or invalid.');
                }
            } catch (error) {
                console.error('Error geocoding postal code:', error);
                alert('An error occurred while geocoding. Please try again.');
            }
        });
    </script>
</body>
</html>
