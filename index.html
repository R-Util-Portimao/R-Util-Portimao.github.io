<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Postal Code Map - Portugal</title>
    <style>
        #map {
            height: 400px;
            width: 100%;
            margin-top: 0px; /* Adjust as needed */
        }
        body {
            margin: 0;
            padding: 0;
            font-family: sans-serif;
        }
        h1 {
            display: none; /* Hide the title as requested */
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        let map = null;
        let markers = L.featureGroup(); // Use a feature group to manage multiple markers

        // **YOUR GEOAPIFY API KEY HERE**
        const GEOAPIFY_API_KEY = "f92e5192f9c44001b7fbcabc7b92ddb7"; 

        // Function to initialize and update the map with multiple locations
        function displayMapWithLocations(locations) {
            if (!map) {
                // Initialize map only once if it doesn't exist
                map = L.map('map').setView([37.12, -8.58], 12); // Default view, maybe Alvor area

                // Use Geoapify Tile Layer
                L.tileLayer(`https://maps.geoapify.com/v1/tile?zoom={z}&lat={y}&lon={x}&apiKey=${GEOAPIFY_API_KEY}`, {
                    attribution: 'Powered by <a href="https://www.geoapify.com/" target="_blank">Geoapify</a> | &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                markers.addTo(map); // Add the feature group to the map
            } else {
                markers.clearLayers(); // Clear existing markers before adding new ones
            }

            if (locations && locations.length > 0) {
                let bounds = L.latLngBounds([]); // To fit all markers on the map

                locations.forEach(location => {
                    if (location.latitude && location.longitude) {
                        const lat = location.latitude;
                        const lon = location.longitude;
                        const postalCode = location.cp || 'N/A';
                        const title = location.title || 'No Title';
                        const address = location.moradaCompleta || 'No Address';
                        const logoUrl = location.logotipo;

                        let popupContent = `<b>${title}</b><br>${address}<br>CP: ${postalCode}<br>Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)}`;

                        if (logoUrl) {
                            popupContent += `<br><img src="${logoUrl}" style="max-width:100px; max-height:100px; margin-top: 5px;">`;
                        }

                        const marker = L.marker([lat, lon])
                            .bindPopup(popupContent);
                        
                        markers.addLayer(marker); // Add marker to the feature group
                        bounds.extend([lat, lon]); // Extend bounds to include this marker
                    }
                });

                if (markers.getLayers().length > 0) {
                    map.fitBounds(bounds, { padding: [50, 50] }); // Fit map to all markers with some padding
                } else {
                    // If no valid markers, set a default view or handle as needed
                    map.setView([37.12, -8.58], 12);
                }

            } else {
                console.log("No valid locations received to display on the map.");
                // Optionally, display a message on the map or set a default view
                map.setView([37.12, -8.58], 12); // Default view if no locations
            }
        }

        // Listen for messages from the Wix parent frame
        window.addEventListener('message', (event) => {
            // No need for event.origin check here as Wix's $w().postMessage handles the origin securely.
            // If you were using window.parent.postMessage() with a targetOrigin,
            // then event.origin check would be crucial.
            
            try {
                const data = JSON.parse(event.data);
                if (Array.isArray(data)) { // Expecting an array of location objects
                    console.log("Received data from Wix:", data);
                    displayMapWithLocations(data);
                } else {
                    console.warn("Received unexpected data format from Wix:", data);
                }
            } catch (e) {
                console.error("Error parsing message from Wix:", e, event.data);
            }
        });

        // Optional: Send a message back to Wix when the iframe is ready to receive data
        // This can be useful for Wix to know when to send the initial data.
        window.parent.postMessage("iframeReady", "*"); // Adjust "*" to your Wix site's domain for security
    </script>
</body>
</html>
