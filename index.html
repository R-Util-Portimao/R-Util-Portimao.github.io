!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa com Dados Recebidos</title>
    <!-- Leaflet CSS for map styling -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
    <style>
        /* Ensures the map takes up the full viewport height and width */
        #map {
            height: 100vh;
            width: 100%;
        }
        /* Resets default browser margins and padding */
        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif; /* Using Inter font for consistency */
        }
        /* Styles for the content inside the popup */
        .popup-content-wrapper {
            display: flex; /* Enables Flexbox for horizontal alignment */
            align-items: center; /* Vertically aligns items in the center */
            gap: 10px; /* Space between the image and text */
            border-radius: 8px; /* Rounded corners for the wrapper */
            padding: 5px; /* Padding around the content */
        }
        .popup-logo {
            width: 50px; /* Fixed width for the logo image */
            height: auto; /* Maintains aspect ratio */
            flex-shrink: 0; /* Prevents the image from shrinking */
            border-radius: 4px; /* Slightly rounded corners for the logo */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* Subtle shadow for the logo */
        }
        .popup-details {
            display: flex;
            flex-direction: column; /* Stacks title and address vertically */
        }
        .popup-title {
            font-weight: bold;
            margin-bottom: 3px; /* Smaller space below the title */
            color: #333; /* Darker color for the title */
        }
        .popup-details span {
            font-size: 0.9em; /* Slightly smaller font for details */
            color: #555; /* Medium gray for details */
        }
        /* Custom styles for Leaflet popups */
        .leaflet-popup-content-wrapper {
            border-radius: 8px; /* Rounded corners for the entire popup */
            box-shadow: 0 4px 8px rgba(0,0,0,0.15); /* More prominent shadow for the popup */
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Leaflet JavaScript library -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
    <script>
        // Initialize the map, centered on Portugal with a zoom level that shows most of the country.
        const map = L.map('map').setView([39.5, -8.0], 7);

        // Add an OpenStreetMap tile layer to the map
        const layer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        });
        layer.addTo(map);

        /**
         * Adds a marker to the map by geocoding an address.
         * @param {Object} item - An object containing address details (address, postalCode, city, title, logotipo).
         * @returns {Array|null} - An array [latitude, longitude] if geocoding is successful, otherwise null.
         */
        async function addPinFromAddress(item) {
            // Construct the full address dynamically.
            // .filter(Boolean) removes any undefined, null, or empty string parts.
            const addressParts = [item.address, item.postalCode, item.city, 'Portugal'].filter(Boolean);
            const fullAddress = addressParts.join(', ');
            const encodedAddress = encodeURIComponent(fullAddress);

            let popupContent = '';
            // Construct the popup content based on whether a logo is available
            if (item.logotipo) {
                popupContent += `<div class="popup-content-wrapper">`;
                // Use a placeholder image if the logotipo URL fails to load
                popupContent += `<img src="${item.logotipo}" alt="Logotipo" class="popup-logo" onerror="this.onerror=null;this.src='https://placehold.co/50x50/cccccc/333333?text=Logo';">`;
                popupContent += `<div class="popup-details">`;
                popupContent += `<span class="popup-title">${item.title || 'Sem título'}</span>`;
                popupContent += `<span>${fullAddress}</span>`;
                popupContent += `</div>`;
                popupContent += `</div>`;
            } else {
                // Simpler popup content if no logo
                popupContent = `<b>${item.title || 'Sem título'}</b><br>${fullAddress}`;
            }

            try {
                // Geocoding request to Nominatim OpenStreetMap API
                // 'countrycodes=pt' helps prioritize results within Portugal
                const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodedAddress}&format=json&limit=1&addressdetails=1&countrycodes=pt`, {
                    headers: {
                        // IMPORTANT: Replace 'YourAppName/1.0 (your-email@example.com)' with your actual app name and contact email.
                        // This is required by Nominatim's usage policy.
                        'User-Agent': 'MyWixMapApp/1.0 (your-email@example.com)' 
                    }
                });
                const data = await response.json();

                // Check if geocoding returned any results
                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);

                    // Create and add a marker to the map, binding the popup content
                    const marker = L.marker([lat, lon])
                        .addTo(map)
                        .bindPopup(popupContent);
                    
                    console.log(`Successfully geocoded "${fullAddress}" to [${lat}, ${lon}]`);
                    return [lat, lon];
                } else {
                    console.warn(`Could not geocode address: "${fullAddress}". No results found. Nominatim response:`, data);
                    return null;
                }
            } catch (error) {
                console.error(`Error geocoding address "${fullAddress}":`, error);
                return null;
            }
        }

        /**
         * Iterates through a list of data items and adds pins to the map for each.
         * After all pins are added, it adjusts the map view to fit all markers.
         * @param {Array<Object>} dados - An array of objects, each containing address information.
         */
        async function adicionarPins(dados) {
            const allCoordinates = [];
            for (const item of dados) {
                const coords = await addPinFromAddress(item);
                if (coords) {
                    allCoordinates.push(coords);
                }
            }
            
            // Adjust map bounds to fit all successfully added markers
            if (allCoordinates.length > 0) {
                map.fitBounds(allCoordinates, { padding: [50, 50] }); // Add padding to keep markers from the edge
            } else {
                console.warn("No valid locations found to display on the map. Map view remains at initial setting.");
            }
        }

        // Event listener to receive messages (data) from the parent frame (e.g., Wix)
        window.addEventListener("message", function (event) {
            try {
                // Attempt to parse the received data as JSON
                const data = JSON.parse(event.data);
                // Check if the parsed data is an array
                if (Array.isArray(data)) {
                    adicionarPins(data); // Call function to add pins
                } else {
                    console.warn("Received data is not an array:", data);
                }
            } catch (e) {
                console.error("Error parsing message from sender:", e);
            }
        }, false); /* 'false' indicates event bubbling phase, 'true' is capturing phase */
    </script>
</body>
</html>
